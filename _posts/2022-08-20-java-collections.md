---
title: "ã€ŠJava é›†åˆæ¡†æ¶è¯¦è§£ã€‹"
date: 2022-08-20 16:00:00 +0800
categories: [ç¼–ç¨‹è¯­è¨€, Java]
tags: [Java, é›†åˆæ¡†æ¶, HashMap, ConcurrentHashMap, ArrayList]
---

## ä¸€ã€HashMap

HashMap æ˜¯ Java ä¸­æœ€å¸¸ç”¨çš„é›†åˆä¹‹ä¸€ï¼Œç†è§£å…¶åº•å±‚å®ç°åŸç†å¯¹äºç¼–å†™é«˜æ•ˆä»£ç è‡³å…³é‡è¦ã€‚

---

### 1. JDK 1.7 ç‰ˆæœ¬

#### ï¼ˆ1ï¼‰ç»„æˆç»“æ„

**æ•°ç»„ + é“¾è¡¨** çš„å½¢å¼ï¼ˆé“¾è¡¨ä¸»è¦ä¸ºäº†è§£å†³å“ˆå¸Œå†²çªè€Œå­˜åœ¨ï¼‰

**å·¥ä½œåŸç†**ï¼š
- HashMap é€šè¿‡ key çš„ hashCode ç»è¿‡ hash æ–¹æ³•å¤„ç†å¾—åˆ° hash å€¼
- é€šè¿‡ `(n - 1) & hash` åˆ¤æ–­å½“å‰å…ƒç´ å­˜æ”¾çš„ä½ç½®ï¼ˆn æŒ‡æ•°ç»„çš„é•¿åº¦ï¼‰
- å¦‚æœå½“å‰ä½ç½®å­˜åœ¨å…ƒç´ ï¼Œå°±åˆ¤æ–­è¯¥å…ƒç´ ä¸è¦å­˜å…¥å…ƒç´ çš„ hash å€¼ä»¥åŠ key æ˜¯å¦ç›¸åŒ
- å¦‚æœç›¸åŒç›´æ¥è¦†ç›–ï¼Œä¸ç›¸åŒå°±é€šè¿‡æ‹‰é“¾æ³•è§£å†³å†²çª

---

#### ï¼ˆ2ï¼‰æºç åˆ†æ

**Entry æ•°ç»„**ï¼šHashMap çš„ä¸»å¹²æ˜¯ä¸€ä¸ª Entry æ•°ç»„ï¼ŒEntry å®ç°äº† Map.Entry æ¥å£ï¼ŒåŒ…å«ï¼š
- key-value é”®å€¼å¯¹
- next æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨
- é€šè¿‡ key è®¡ç®—å‡ºæ¥çš„ hashcode

```java
transient Entry<K,V>[] table = (Entry<K,V>[]) EMPTY_TABLE;
```

**åˆå§‹åŒ–å‚æ•°**ï¼š

```java
// åˆå§‹åŒ–æ¡¶å¤§å°ï¼Œé»˜è®¤æ˜¯ 16
static final int DEFAULT_INITIAL_CAPACITY = 1 << 4; // aka 16

// æ¡¶æœ€å¤§å€¼
static final int MAXIMUM_CAPACITY = 1 << 30;

// é»˜è®¤çš„è´Ÿè½½å› å­ï¼ˆ0.75ï¼‰
static final float DEFAULT_LOAD_FACTOR = 0.75f;

// table çœŸæ­£å­˜æ”¾æ•°æ®çš„æ•°ç»„
transient Entry<K,V>[] table = (Entry<K,V>[]) EMPTY_TABLE;

// Map å­˜æ”¾æ•°é‡çš„å¤§å°
transient int size;

// æ¡¶å¤§å°ï¼Œå¯åœ¨åˆå§‹åŒ–æ—¶æ˜¾å¼æŒ‡å®š
int threshold;

// è´Ÿè½½å› å­ï¼Œå¯åœ¨åˆå§‹åŒ–æ—¶æ˜¾å¼æŒ‡å®š
final float loadFactor;
```

---

#### ï¼ˆ3ï¼‰æ³¨æ„ç‚¹

##### â‘  æ‰©å®¹æœºåˆ¶

- ç»™å®šçš„åˆå§‹å®¹é‡ä¸º 16ï¼ˆæ•°ç»„é•¿åº¦ï¼‰ï¼Œè´Ÿè½½å› å­ä¸º 0.75
- Map åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ä¸æ–­å­˜æ”¾æ•°æ®ï¼Œå½“æ•°é‡è¾¾åˆ° `16 * 0.75 = 12` å°±éœ€è¦æ‰©å®¹
- æ‰©å®¹è¿‡ç¨‹æ¶‰åŠåˆ° rehashã€å¤åˆ¶æ•°æ®ç­‰æ“ä½œï¼Œ**éå¸¸æ¶ˆè€—æ€§èƒ½**

##### â‘¡ è´Ÿè½½å› å­

**å®šä¹‰**ï¼šè´Ÿè½½å› å­æ§åˆ¶æ•°ç»„å­˜æ”¾æ•°æ®çš„ç–å¯†ç¨‹åº¦

- **è¶Šè¶‹è¿‘äº 1**ï¼šæ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®è¶Šå¤šï¼Œé“¾è¡¨çš„é•¿åº¦å¢åŠ ï¼ŒæŸ¥æ‰¾æ•ˆç‡é™ä½
- **è¶Šè¶‹è¿‘äº 0**ï¼šæ•°ç»„ä¸­å­˜æ”¾çš„æ•°æ®è¶Šå°‘ï¼Œæ•°ç»„åˆ©ç”¨ç‡ä½ï¼Œå­˜æ”¾çš„æ•°æ®ä¼šå¾ˆåˆ†æ•£

> ğŸ’¡ **ä¸ºä»€ä¹ˆé»˜è®¤æ˜¯ 0.75ï¼Ÿ**
> 
> 0.75f æ˜¯å®˜æ–¹ç»™å‡ºçš„ä¸€ä¸ªæ¯”è¾ƒå¥½çš„ä¸´ç•Œå€¼ï¼Œåœ¨æ—¶é—´å’Œç©ºé—´æˆæœ¬ä¹‹é—´å–å¾—äº†å¹³è¡¡ã€‚

##### â‘¢ ä¸ºä»€ä¹ˆæ‰©å®¹æ˜¯ 2 çš„å€æ•°ï¼Ÿ

**åŸå›  1ï¼šè®¡ç®—æ•ˆç‡**
- HashMap é€šè¿‡ `(n-1) & hash` æ¥ç¡®å®šç´¢å¼•ä½ç½®ï¼Œå®é™…ä¸Šç›¸å½“äº `hash % n` å–ä½™æ•°
- å½“å®¹é‡ä¸º 2 çš„ n æ¬¡å¹‚æ—¶ï¼Œ`n-1` çš„äºŒè¿›åˆ¶è¡¨ç¤ºéƒ½æ˜¯ `...1111` çš„å½¢å¼
- ä¾‹å¦‚ï¼š15 çš„äºŒè¿›åˆ¶æ˜¯ `1111`ï¼Œ31 çš„äºŒè¿›åˆ¶æ˜¯ `11111`
- ä¸è¿ç®—æ¯”å–ä½™è¿ç®—é€Ÿåº¦æ›´å¿«

**åŸå›  2ï¼šæ‰©å®¹ä¼˜åŒ–**
- æ‰©å®¹æ—¶åªç§»åŠ¨å¤§çº¦ä¸€åŠçš„æ•°æ®
- ä¸ä¼šé€ æˆæ‰©å®¹ä¹‹åç¢°æ’æ›´åŠ ä¸¥é‡çš„æƒ…å†µ

**åŸå›  3ï¼šå‡åŒ€åˆ†æ•£**
- åœ¨ JDK 1.8 ä¸­ï¼Œresize è¿‡ç¨‹å› ä¸ºå®¹é‡ç¿»å€ï¼Œåªä¼šåœ¨ `n-1` çš„äºŒè¿›åˆ¶é«˜ä½æ–°å¢ä¸€ä¸ª bit ä½
- è¿™ä¸ª bit ä½ä¸ hash å€¼å¯¹åº”ä½ç½®ä¸æ“ä½œæ˜¯ 0 çš„è¯ç´¢å¼•æ²¡å˜ï¼Œæ˜¯ 1 çš„è¯ç´¢å¼•å˜æˆ"åŸç´¢å¼• + oldCap"
- å‡åŒ€åœ°æŠŠä¹‹å‰å†²çªçš„èŠ‚ç‚¹åˆ†æ•£åˆ°æ–°çš„æ•°ç»„é‡Œ

---

### 2. JDK 1.8 ç‰ˆæœ¬

#### ï¼ˆ1ï¼‰å¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹

**JDK 1.7 çš„é—®é¢˜**ï¼š
- å½“ Hash å†²çªä¸¥é‡æ—¶ï¼Œæ¡¶ä¸Šå½¢æˆçš„é“¾è¡¨ä¼šå˜å¾—è¶Šæ¥è¶Šé•¿
- æŸ¥è¯¢æ•ˆç‡è¶Šæ¥è¶Šä½ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º O(N)

#### ï¼ˆ2ï¼‰ç»„æˆç»“æ„

**æ•°ç»„ + ï¼ˆé“¾è¡¨/çº¢é»‘æ ‘ï¼‰**

#### ï¼ˆ3ï¼‰ä¸»è¦åŒºåˆ«

| ç‰¹æ€§ | JDK 1.7 | JDK 1.8 |
|------|---------|---------|
| **æ•°æ®ç»“æ„** | æ•°ç»„ + é“¾è¡¨ | æ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘ |
| **æ’å…¥æ–¹å¼** | å¤´æ’æ³• | å°¾æ’æ³• |
| **é“¾è¡¨è½¬çº¢é»‘æ ‘** | ä¸æ”¯æŒ | é“¾è¡¨é•¿åº¦ > 8 ä¸”æ•°ç»„é•¿åº¦ â‰¥ 64 æ—¶è½¬æ¢ |
| **æ‰©å®¹é—®é¢˜** | å¯èƒ½å¯¼è‡´é“¾è¡¨æˆç¯ | å°¾æ’æ³•è§£å†³äº†é“¾è¡¨æˆç¯é—®é¢˜ |

> âš ï¸ **æ³¨æ„**ï¼šJDK 1.8 è™½ç„¶è§£å†³äº†é“¾è¡¨æˆç¯é—®é¢˜ï¼Œä½†ä»ç„¶å­˜åœ¨å¤šçº¿ç¨‹ä¸‹æ•°æ®ä¸¢å¤±çš„é—®é¢˜ã€‚

**è½¬æ¢è§„åˆ™**ï¼š
- å½“é“¾è¡¨é•¿åº¦å¤§äºé˜ˆå€¼ï¼ˆé»˜è®¤ä¸º 8ï¼‰æ—¶ï¼Œä¼šé¦–å…ˆè°ƒç”¨ `treeifyBin()` æ–¹æ³•
- è¿™ä¸ªæ–¹æ³•ä¼šæ ¹æ® HashMap æ•°ç»„æ¥å†³å®šæ˜¯å¦è½¬æ¢ä¸ºçº¢é»‘æ ‘
- **åªæœ‰å½“æ•°ç»„é•¿åº¦å¤§äºæˆ–ç­‰äº 64** çš„æƒ…å†µä¸‹ï¼Œæ‰ä¼šæ‰§è¡Œè½¬æ¢çº¢é»‘æ ‘æ“ä½œ
- å¦åˆ™ï¼Œåªæ˜¯æ‰§è¡Œ `resize()` æ–¹æ³•å¯¹æ•°ç»„æ‰©å®¹

---

### 3. put æ–¹æ³•æµç¨‹

```java
// put æ–¹æ³•çš„æ ¸å¿ƒæµç¨‹
```

1. æ ¹æ®å½“å‰ key çš„ hashcode å®šä½åˆ°å…·ä½“çš„æ¡¶ä¸­å¹¶åˆ¤æ–­æ˜¯å¦ä¸ºç©º
   - ä¸ºç©ºè¡¨æ˜æ²¡æœ‰ Hash å†²çªï¼Œç›´æ¥åœ¨å½“å‰ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°æ¡¶å³å¯
2. å¦‚æœå½“å‰æ¡¶æœ‰å€¼ï¼ˆHash å†²çªï¼‰ï¼Œé‚£ä¹ˆå°±è¦æ¯”è¾ƒå½“å‰æ¡¶ä¸­çš„ key
   - key ç›¸ç­‰åˆ™è¦†ç›–
   - ä¸ç­‰åˆ™é€šè¿‡æ­¥éª¤ 3ã€4 è§£å†³
3. å¦‚æœå½“å‰æ¡¶ä¸ºçº¢é»‘æ ‘ï¼Œé‚£å°±è¦æŒ‰ç…§çº¢é»‘æ ‘çš„æ–¹å¼å†™å…¥æ•°æ®
4. å¦‚æœæ˜¯ä¸ªé“¾è¡¨ï¼Œå°±éœ€è¦å°†å½“å‰çš„ keyã€value å°è£…æˆä¸€ä¸ªæ–°èŠ‚ç‚¹å†™å…¥åˆ°å½“å‰æ¡¶çš„åé¢ï¼ˆå½¢æˆé“¾è¡¨ï¼‰
5. æ¥ç€åˆ¤æ–­å½“å‰é“¾è¡¨çš„å¤§å°æ˜¯å¦å¤§äºé¢„è®¾çš„é˜ˆå€¼
   - å¤§äºæ—¶å°±è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘ï¼ˆå‰ææ˜¯æ•°ç»„é•¿åº¦ â‰¥ 64ï¼Œå¦åˆ™ `resize()` æ‰©å®¹ï¼‰
6. æœ€ååˆ¤æ–­æ˜¯å¦æ•´ä¸ª map çš„ size æ˜¯å¦å¤§äºé¢„è®¾ thresholdï¼Œéœ€è¦è¿›è¡Œæ‰©å®¹

---

### 4. get æ–¹æ³•æµç¨‹

1. é¦–å…ˆå°† key çš„ hashcode hash ä¹‹åå–å¾—æ‰€å®šä½çš„æ¡¶
2. åˆ¤æ–­æ¡¶çš„ç¬¬ä¸€ä¸ªä½ç½®ï¼ˆæœ‰å¯èƒ½æ˜¯é“¾è¡¨ã€çº¢é»‘æ ‘ï¼‰çš„ key æ˜¯å¦ä¸ºæŸ¥è¯¢çš„ key
   - æ˜¯å°±ç›´æ¥è¿”å› value
3. å¦‚æœç¬¬ä¸€ä¸ªä¸åŒ¹é…ï¼Œåˆ™åˆ¤æ–­å®ƒçš„ä¸‹ä¸€ä¸ªæ˜¯çº¢é»‘æ ‘è¿˜æ˜¯é“¾è¡¨
   - çº¢é»‘æ ‘å°±æŒ‰ç…§æ ‘çš„æŸ¥æ‰¾æ–¹å¼è¿”å›å€¼
   - ä¸ç„¶å°±æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼éå†åŒ¹é…è¿”å›å€¼

---

### 5. resize æ‰©å®¹æ–¹æ³•

è¿›è¡Œæ‰©å®¹ï¼Œä¼šä¼´éšç€ä¸€æ¬¡é‡æ–° hash åˆ†é…ï¼Œå¹¶ä¸”ä¼šéå† hash è¡¨ä¸­æ‰€æœ‰çš„å…ƒç´ ï¼Œ**éå¸¸è€—æ—¶**ã€‚

> ğŸ’¡ **æœ€ä½³å®è·µ**ï¼šåœ¨ç¼–å†™ç¨‹åºæ—¶ï¼Œè¦å°½é‡é¿å… resizeï¼Œå¯ä»¥åœ¨åˆå§‹åŒ–æ—¶æŒ‡å®šåˆé€‚çš„å®¹é‡ã€‚

---

### 6. HashMap å®‰å…¨é—®é¢˜

#### ï¼ˆ1ï¼‰HashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„

#### ï¼ˆ2ï¼‰å¯èƒ½å‡ºç°çš„é—®é¢˜

- **JDK 1.7**ï¼šå¹¶å‘åœºæ™¯ä¸‹ä½¿ç”¨æ—¶å®¹æ˜“å‡ºç°æ­»å¾ªç¯
  - åœ¨ HashMap æ‰©å®¹æ—¶ä¼šè°ƒç”¨ `resize()` æ–¹æ³•
  - å¹¶å‘æ“ä½œå®¹æ˜“åœ¨ä¸€ä¸ªæ¡¶ä¸Šå½¢æˆç¯å½¢é“¾è¡¨
  - å½“è·å–ä¸€ä¸ªä¸å­˜åœ¨çš„ key æ—¶ï¼Œè®¡ç®—å‡ºçš„ index æ­£å¥½æ˜¯ç¯å½¢é“¾è¡¨çš„ä¸‹æ ‡å°±ä¼šå‡ºç°æ­»å¾ªç¯
  
- **JDK 1.8**ï¼šé€šè¿‡å°¾æ’æ³•è§£å†³äº†é“¾è¡¨æˆç¯é—®é¢˜ï¼Œä½†ä»ç„¶å¯èƒ½å‡ºç°æ•°æ®ä¸¢å¤±ç­‰é—®é¢˜

> âš ï¸ **å»ºè®®**ï¼šå¤šçº¿ç¨‹ä¸‹ä¸å»ºè®®ä½¿ç”¨ HashMapï¼Œåº”è¯¥ä½¿ç”¨ ConcurrentHashMapã€‚

---

### 7. ä½¿ç”¨ç»†èŠ‚

```java
// åˆ›å»º HashMap
Map<Integer, Integer> maps = new HashMap<Integer, Integer>();

// å†™å…¥
maps.put(222, 333);

// è¯»å–
maps.get(222);

// è¿­ä»£æ–¹å¼
Iterator<Map.Entry<Integer, Integer>> iterator = maps.entrySet().iterator();
while (iterator.hasNext()) {
    Map.Entry<Integer, Integer> next = iterator.next();
    System.out.println("key=" + next.getKey() + " value=" + next.getValue());
}
```

**æ³¨æ„äº‹é¡¹**ï¼š
- HashMap ä½¿ç”¨æ³›å‹ï¼Œä¸”æ³›å‹åªèƒ½æ˜¯å¼•ç”¨æ•°æ®ç±»å‹
- put å†™å…¥ int å‹çš„æ•°æ®ä¼šè‡ªåŠ¨è½¬åŒ–ä¸º Integerï¼ˆè‡ªåŠ¨è£…ç®±ï¼‰
- get è¯»å–æ•°æ®ä¼šæŠŠ Integer è‡ªåŠ¨è½¬åŒ–ä¸º intï¼ˆè‡ªåŠ¨æ‹†ç®±ï¼‰

---

### 8. ä½¿ç”¨åœºæ™¯

- âœ… åšæ•°æ®åŒ¹é…
- âœ… é€‚åˆä¸€æ¬¡å†™å…¥ï¼Œå¤šæ¬¡è¯»å–çš„åœºæ™¯

> ğŸ’¡ **æ‰©å±•çŸ¥è¯†**ï¼šRedis æ•°æ®åº“åº•å±‚çš„æ•´ä½“ç»“æ„å°±æ˜¯ä¸€ä¸ª HashMapï¼Œé€‚åˆ token ç­‰ä¸€æ¬¡å†™å…¥ã€å¤šæ¬¡è¯»å–çš„åœºæ™¯ã€‚

---

### 9. æ—¶é—´å¤æ‚åº¦

| æ“ä½œ | æ—¶é—´å¤æ‚åº¦ | è¯´æ˜ |
|------|-----------|------|
| **å•æŸ¥** | O(1) | ç›´æ¥å®šä½åˆ°æ¡¶ |
| **æ•´ä½“æ•°æ®åŒ¹é…** | O(n) | éå†æ‰€æœ‰å…ƒç´  |
| **å•æ¬¡åˆ æ”¹** | O(1) | ç›´æ¥å®šä½ |
| **å•æ¬¡æ’å…¥ï¼ˆæ— å†²çªï¼‰** | O(1) | é“¾è¡¨æœªè¾¾åˆ°é˜ˆå€¼ |
| **å•æ¬¡æ’å…¥ï¼ˆæ‰©å®¹ï¼‰** | O(n) | æ•°ç»„æ‰©å®¹ï¼Œéœ€è¦ rehashï¼Œé‡æ–°æ•£åˆ— |

---

## äºŒã€ConcurrentHashMap

ConcurrentHashMap æ˜¯çº¿ç¨‹å®‰å…¨çš„ HashMapï¼Œåœ¨å¹¶å‘ç¼–ç¨‹ä¸­è¢«å¹¿æ³›ä½¿ç”¨ã€‚

---

### 1. JDK 1.7 ç‰ˆæœ¬

#### ï¼ˆ1ï¼‰ç»„æˆç»“æ„

**Segment æ•°ç»„ + HashEntry æ•°ç»„** = æ•°ç»„ + é“¾è¡¨çš„å½¢å¼

#### ï¼ˆ2ï¼‰å®ç°åŸç†

**åˆ†æ®µé”æŠ€æœ¯**ï¼š
- ConcurrentHashMap é‡‡ç”¨äº†åˆ†æ®µé”æŠ€æœ¯
- Segment ç»§æ‰¿äº ReentrantLock
- ä¸ä¼šåƒ HashTable é‚£æ ·ä¸ç®¡æ˜¯ put è¿˜æ˜¯ get æ“ä½œéƒ½éœ€è¦åšåŒæ­¥å¤„ç†
- ç†è®ºä¸Š ConcurrentHashMap æ”¯æŒ CurrencyLevelï¼ˆSegment æ•°ç»„æ•°é‡ï¼‰çš„çº¿ç¨‹å¹¶å‘
- æ¯å½“ä¸€ä¸ªçº¿ç¨‹å ç”¨é”è®¿é—®ä¸€ä¸ª Segment æ—¶ï¼Œä¸ä¼šå½±å“åˆ°å…¶ä»–çš„ Segment
- æ¯ä¸€ä¸ª Segment å­˜å‚¨çš„éƒ½æ˜¯ä¸€ä¸ª HashMap ç»“æ„
- **Segment çš„ä¸ªæ•°ä¸€æ—¦åˆå§‹åŒ–å°±ä¸èƒ½æ”¹å˜**ï¼Œé»˜è®¤ Segment çš„ä¸ªæ•°æ˜¯ 16

---

#### ï¼ˆ3ï¼‰æºç åˆ†æ

**HashEntry ç»„æˆ**ï¼š
- å’Œ HashMap éå¸¸ç±»ä¼¼
- å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å…¶ä¸­çš„æ ¸å¿ƒæ•°æ®å¦‚ valueï¼Œä»¥åŠé“¾è¡¨éƒ½æ˜¯ **volatile ä¿®é¥°**çš„
- ä¿è¯äº†è·å–æ—¶çš„å¯è§æ€§

**put æ“ä½œ**ï¼š
1. é¦–å…ˆé€šè¿‡ key å®šä½åˆ° Segment
   - å¦‚æœæŒ‡å®šä½ç½®çš„ Segment ä¸ºç©ºï¼Œåˆ™åˆå§‹åŒ–è¿™ä¸ª Segment
2. ä¹‹ååœ¨å¯¹åº”çš„ Segment ä¸­è¿›è¡Œå…·ä½“çš„ put
3. è™½ç„¶ HashEntry ä¸­çš„ value æ˜¯ç”¨ volatile å…³é”®è¯ä¿®é¥°çš„ï¼Œä½†ä¸èƒ½ä¿è¯å¹¶å‘çš„åŸå­æ€§
   - æ‰€ä»¥ put æ“ä½œæ—¶ä»ç„¶éœ€è¦åŠ é”å¤„ç†
4. ç¬¬ä¸€æ­¥æ—¶ä¼šå°è¯•è·å–é”
   - å¦‚æœè·å–å¤±è´¥è‚¯å®šå°±æœ‰å…¶ä»–çº¿ç¨‹å­˜åœ¨ç«äº‰
   - åˆ™åˆ©ç”¨ `scanAndLockForPut()` è‡ªæ—‹è·å–é”
5. å¦‚æœé‡è¯•çš„æ¬¡æ•°è¾¾åˆ°äº† `MAX_SCAN_RETRIES`
   - åˆ™æ”¹ä¸º `lock()` é˜»å¡è·å–é”ï¼Œä¿è¯èƒ½è·å–æˆåŠŸ

**get æ“ä½œ**ï¼š
1. åªéœ€è¦å°† Key é€šè¿‡ Hash ä¹‹åå®šä½åˆ°å…·ä½“çš„ Segment
2. å†é€šè¿‡ä¸€æ¬¡ Hash å®šä½åˆ°å…·ä½“çš„å…ƒç´ ä¸Š
3. ç”±äº HashEntry ä¸­çš„ value å±æ€§æ˜¯ç”¨ volatile å…³é”®è¯ä¿®é¥°çš„
   - ä¿è¯äº†å†…å­˜å¯è§æ€§ï¼Œæ‰€ä»¥æ¯æ¬¡è·å–æ—¶éƒ½æ˜¯æœ€æ–°å€¼

> âœ… **é«˜æ•ˆ**ï¼šConcurrentHashMap çš„ get æ–¹æ³•éå¸¸é«˜æ•ˆï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½ä¸éœ€è¦åŠ é”ã€‚

---

### 2. JDK 1.8 ç‰ˆæœ¬

#### ï¼ˆ1ï¼‰ä¸»è¦æ”¹è¿›

**è§£å†³é“¾è¡¨æŸ¥è¯¢ä½æ•ˆçš„é—®é¢˜**ï¼š
- æŠ›å¼ƒäº†åŸæœ‰çš„ Segment åˆ†æ®µé”
- é‡‡ç”¨äº† **CAS + synchronized** æ¥ä¿è¯å¹¶å‘å®‰å…¨æ€§
- **Node æ•°ç»„ + é“¾è¡¨/çº¢é»‘æ ‘**
- å½“å†²çªé“¾è¡¨è¾¾åˆ°ä¸€å®šé•¿åº¦æ—¶ï¼Œé“¾è¡¨ä¼šè½¬æ¢æˆçº¢é»‘æ ‘

**Node èŠ‚ç‚¹**ï¼š
- å°† 1.7 ä¸­å­˜æ”¾æ•°æ®çš„ HashEntry æ”¹ä¸º Nodeï¼Œä½œç”¨ç›¸åŒ
- å…¶ä¸­çš„ valã€next éƒ½ç”¨äº† volatile ä¿®é¥°ï¼Œä¿è¯äº†å¯è§æ€§

---

#### ï¼ˆ2ï¼‰put æ“ä½œ

1. æ ¹æ® key è®¡ç®—å‡º hashcodeï¼Œè®¡ç®—å‡ºæ¡¶çš„ä½ç½®
2. å½“å‰ key å®šä½å‡ºçš„ Nodeï¼Œå¦‚æœä¸ºç©ºè¡¨ç¤ºå½“å‰ä½ç½®å¯ä»¥å†™å…¥æ•°æ®
   - åˆ©ç”¨ CAS å°è¯•å†™å…¥ï¼Œå¤±è´¥åˆ™è‡ªæ—‹ä¿è¯æˆåŠŸ
3. å¦‚æœå½“å‰ä½ç½®çš„ `hashcode == MOVED == -1`ï¼Œåˆ™éœ€è¦è¿›è¡Œæ‰©å®¹
4. å¦‚æœéƒ½ä¸æ»¡è¶³ï¼Œåˆ™åˆ©ç”¨ **synchronized é”**å†™å…¥æ•°æ®
5. å¦‚æœæ•°é‡å¤§äº `TREEIFY_THRESHOLD` åˆ™è¦è½¬æ¢ä¸ºçº¢é»‘æ ‘

---

#### ï¼ˆ3ï¼‰get æ“ä½œ

1. æ ¹æ®è®¡ç®—å‡ºæ¥çš„ hashcode å¯»å€
   - å¦‚æœå°±åœ¨æ¡¶ä¸Šé‚£ä¹ˆç›´æ¥è¿”å›å€¼
2. å¦‚æœæ˜¯çº¢é»‘æ ‘é‚£å°±æŒ‰ç…§æ ‘çš„æ–¹å¼è·å–å€¼
3. å¦‚æœä¸æ»¡è¶³é‚£å°±æŒ‰ç…§é“¾è¡¨çš„æ–¹å¼éå†è·å–å€¼

---

## ä¸‰ã€HashTable

### 1. æ—¶é—´å¤æ‚åº¦

HashTable å“ˆå¸Œè¡¨ï¼šç†è®ºä¸Šå¢åˆ æ”¹æŸ¥ **O(1)** çº§åˆ«ï¼ˆæš‚æ—¶ä¸è€ƒè™‘å“ˆå¸Œå†²çªï¼‰

**ä¸ºä»€ä¹ˆæ˜¯ O(1) çº§åˆ«ï¼Ÿ**
- HashTable æœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ ¹æ®ç´¢å¼•"åˆ æŸ¥æ”¹"ï¼Œæ˜¯ O(1) çº§åˆ«

> ğŸ“ **ä¸¾ä¾‹**ï¼š`maps.get("name")` å·¥ä½œåŸç†
> 
> æ ¹æ® name çš„ hashcode é€šè¿‡å“ˆå¸Œå‡½æ•°è®¡ç®—å‡ºç´¢å¼•åœ°å€ï¼Œå°±èƒ½æ‰¾åˆ°æ•°ç»„ä¸­å¯¹åº”çš„å­˜å‚¨ä½ç½®
> 
> å…¬å¼ï¼š`ç´¢å¼•åœ°å€ = f(hashcode)`

---

### 2. HashMap å’Œ HashTable çš„åŒºåˆ«

#### ç›¸åŒç‚¹

- éƒ½æ˜¯å­˜å‚¨ key-value é”®å€¼å¯¹çš„

#### ä¸åŒç‚¹

| ç‰¹æ€§ | HashMap | HashTable |
|------|---------|-----------|
| **null å€¼** | å¯ä»¥å­˜å‚¨ null çš„ key å’Œ value<br>null ä½œä¸ºé”®åªèƒ½æœ‰ä¸€ä¸ª<br>null ä½œä¸ºå€¼å¯ä»¥æœ‰å¤šä¸ª | ä¸å…è®¸æœ‰ null é”®å’Œ null å€¼ |
| **çº¿ç¨‹å®‰å…¨** | æ²¡æœ‰è€ƒè™‘åŒæ­¥ï¼Œçº¿ç¨‹ä¸å®‰å…¨ | çº¿ç¨‹å®‰å…¨ï¼Œå¤§å¤šæ•°æ–¹æ³•ç”¨ synchronized ä¿®é¥° |
| **åˆå§‹å®¹é‡** | é»˜è®¤ 16 | é»˜è®¤ 11 |
| **å®¹é‡å¢é•¿** | æ¯æ¬¡å˜ä¸º"åŸå§‹å®¹é‡ Ã— 2" | æ¯æ¬¡å˜ä¸º"åŸå§‹å®¹é‡ Ã— 2 + 1" |
| **ç»§æ‰¿** | ç»§æ‰¿äº AbstractMap ç±» | ç»§æ‰¿äº Dictionary ç±» |
| **è¿­ä»£å™¨** | Iterator æ˜¯ fail-fast è¿­ä»£å™¨ | enumerator è¿­ä»£å™¨ä¸æ˜¯ fail-fast çš„ |
| **hash ç®—æ³•** | ä½¿ç”¨è‡ªå®šä¹‰çš„å“ˆå¸Œç®—æ³• | ç›´æ¥é‡‡ç”¨ key çš„ hashCode() |

> ğŸ’¡ **fail-fast æœºåˆ¶**ï¼šå½“æœ‰å…¶å®ƒçº¿ç¨‹æ”¹å˜äº† HashMap çš„ç»“æ„ï¼ˆå¢åŠ æˆ–ç§»é™¤å…ƒç´ ï¼‰ï¼Œå°†ä¼šæŠ›å‡º ConcurrentModificationExceptionã€‚

---

## å››ã€Set

Set é›†åˆçš„ç‰¹ç‚¹æ˜¯**ä¸å…è®¸é‡å¤å…ƒç´ **ã€‚

---

### 1. HashSetï¼ˆæ— åºï¼Œå”¯ä¸€ï¼‰

**åº•å±‚å®ç°**ï¼šé€šè¿‡ HashMap ç»“æ„ï¼Œç»§æ‰¿ Set çˆ¶ç±»

```java
Set<Integer> sets = new HashSet<Integer>();
```

**ç»“æ„**ï¼šæ•°ç»„ + é“¾è¡¨ï¼Œæ•°æ®æ˜¯æ— åºçš„

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… æŠŠä¸€å †æ•°æ®å­˜åˆ° HashSet é‡Œé¢ï¼Œç„¶åæŸ¥æ‰¾æŸä¸ªæ•°æ®å­˜ä¸å­˜åœ¨
- âœ… å»é™¤ä¸€å †æ•°æ®ä¸­çš„é‡å¤é¡¹

**ä¸»è¦ä½œç”¨**ï¼šå»é‡

---

### 2. TreeSetï¼ˆæœ‰åºï¼Œå”¯ä¸€ï¼‰

**åº•å±‚å®ç°**ï¼šé€šè¿‡çº¢é»‘æ ‘ï¼Œç»§æ‰¿ Set çˆ¶ç±»

```java
Set<Integer> sets = new TreeSet<Integer>();
```

**ç»“æ„**ï¼šçº¢é»‘æ ‘ï¼Œkey å€¼ä¸å…è®¸ä¸ºç©ºï¼Œæ•°æ®æ˜¯æœ‰åºçš„

**ä¸»è¦ä½œç”¨**ï¼šå»é‡ + æ’åº

---

### 3. comparable å’Œ Comparator çš„åŒºåˆ«

| æ¥å£ | åŒ… | æ–¹æ³• | è¯´æ˜ |
|------|---|------|------|
| **Comparable** | java.lang | `compareTo(Object obj)` | ç”¨äºå¯¹è±¡è‡ªç„¶æ’åº |
| **Comparator** | java.util | `compare(Object obj1, Object obj2)` | ç”¨äºè‡ªå®šä¹‰æ’åº |

**ä½¿ç”¨åœºæ™¯**ï¼š
- å½“éœ€è¦å¯¹ä¸€ä¸ªé›†åˆä½¿ç”¨è‡ªå®šä¹‰æ’åºæ—¶ï¼Œé‡å†™ `compareTo()` æˆ– `compare()` æ–¹æ³•
- å¦‚æœéœ€è¦å¯¹æŸä¸€ä¸ªé›†åˆå®ç°ä¸¤ç§æ’åºæ–¹å¼ï¼ˆå¦‚ song å¯¹è±¡æŒ‰æ­Œåå’Œæ­Œæ‰‹ååˆ†åˆ«æ’åºï¼‰
  - å¯ä»¥é‡å†™ `compareTo()` æ–¹æ³• + ä½¿ç”¨è‡ªåˆ¶çš„ Comparator æ–¹æ³•
  - æˆ–è€…ç”¨ä¸¤ä¸ª Comparator å®ç°ï¼Œä½¿ç”¨ä¸¤ä¸ªå‚æ•°ç‰ˆçš„ `Collections.sort()`

---

### 4. æ¯”è¾ƒ HashSetã€LinkedHashSet å’Œ TreeSet

| ç‰¹æ€§ | HashSet | LinkedHashSet | TreeSet |
|------|---------|--------------|---------|
| **åº•å±‚å®ç°** | HashMap | HashSet çš„å­ç±» | çº¢é»‘æ ‘ |
| **çº¿ç¨‹å®‰å…¨** | ä¸å®‰å…¨ | ä¸å®‰å…¨ | ä¸å®‰å…¨ |
| **null å€¼** | å¯ä»¥å­˜å‚¨ | å¯ä»¥å­˜å‚¨ | ä¸å¯ä»¥å­˜å‚¨ |
| **æœ‰åºæ€§** | æ— åº | æŒ‰ç…§æ·»åŠ é¡ºåº | è‡ªç„¶æ’åºæˆ–å®šåˆ¶æ’åº |
| **ç‰¹ç‚¹** | Set çš„ä¸»è¦å®ç°ç±» | èƒ½å¤ŸæŒ‰ç…§æ·»åŠ é¡ºåºéå† | å¯ä»¥æŒ‰ç…§æ·»åŠ å…ƒç´ çš„é¡ºåºéå† |

---

## äº”ã€List

List é›†åˆçš„ç‰¹ç‚¹æ˜¯**æœ‰åºã€å¯é‡å¤**ã€‚

---

### 1. ArrayListï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰

**åº•å±‚å®ç°**ï¼šæ•°ç»„é˜Ÿåˆ—ï¼Œç›¸å½“äºåŠ¨æ€æ•°ç»„

ä¸ Java ä¸­çš„æ•°ç»„ç›¸æ¯”ï¼Œå®ƒçš„å®¹é‡èƒ½åŠ¨æ€å¢é•¿ã€‚

#### æ‰©å®¹åŸç†ï¼ˆJDK 1.8ï¼‰

1. æ·»åŠ å…ƒç´ æ—¶ï¼Œé¦–å…ˆåˆ¤æ–­æ˜¯å¦å¤§äºé»˜è®¤å®¹é‡ 10
2. å¦‚æœå°äºé»˜è®¤å®¹é‡ï¼Œç›´æ¥åœ¨åŸæ¥åŸºç¡€ä¸Š +1ï¼Œå…ƒç´ æ·»åŠ å®Œæ¯•
3. å¦‚æœå¤§äºé»˜è®¤å®¹é‡ï¼Œåˆ™éœ€è¦è¿›è¡Œæ‰©å®¹ï¼Œæ‰©å®¹æ ¸å¿ƒæ˜¯ `grow()` æ–¹æ³•
   - 3.1 æ‰©å®¹ä¹‹å‰ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œä¸”æ—§æ•°ç»„è¢«å¤åˆ¶åˆ°æ–°æ•°ç»„ä¸­
   - 3.2 ç„¶åé€šè¿‡ä½è¿ç®—ç¬¦å°†æ–°çš„å®¹é‡æ›´æ–°ä¸ºæ—§å®¹é‡çš„ **1.5 å€**
     - `int newCapacity = oldCapacity + (oldCapacity >> 1)`
     - åŸæ¥é•¿åº¦çš„ä¸€åŠå†åŠ ä¸ŠåŸé•¿åº¦
   - 3.3 å¦‚æœæ–°çš„å®¹é‡ - æ—§çš„å®¹é‡ <= 0ï¼Œå°±æ‹¿æ–°çš„å®¹é‡ - æœ€å¤§å®¹é‡é•¿åº¦
     - å¦‚æœ <= 0ï¼Œé‚£ä¹ˆæœ€ç»ˆå®¹é‡å°±æ˜¯æ‰©å®¹åçš„å®¹é‡

#### ä¸ºä»€ä¹ˆæ˜¯ 1.5 å€ï¼Ÿ

```java
int newCapacity = oldCapacity + (oldCapacity >> 1)
```

- `>> 1` ç›¸å½“äºé™¤ä»¥ 2
- æ‰€ä»¥ ArrayList æ¯æ¬¡æ‰©å®¹ä¹‹åå®¹é‡éƒ½ä¼šå˜ä¸ºåŸæ¥çš„ **1.5 å€å·¦å³**
  - oldCapacity ä¸ºå¶æ•°å°±æ˜¯ 1.5 å€
  - å¦åˆ™æ˜¯ 1.5 å€å·¦å³

---

### 2. LinkedListï¼ˆçº¿ç¨‹ä¸å®‰å…¨ï¼‰

**åº•å±‚æ•°æ®ç»“æ„**ï¼šåŒå‘é“¾è¡¨

> ğŸ“Œ **å†å²å˜åŒ–**ï¼šJDK 1.6 ä¹‹å‰ä¸ºå¾ªç¯é“¾è¡¨ï¼ŒJDK 1.7 å–æ¶ˆäº†å¾ªç¯

#### ä¸ºä»€ä¹ˆå–æ¶ˆå¾ªç¯ï¼Ÿ

1. **ä»£ç æ›´æ¸…æ™°**ï¼šfirst/last æœ‰æ›´æ¸…æ™°çš„é“¾å¤´ã€é“¾å°¾æ¦‚å¿µï¼Œä»£ç çœ‹èµ·æ¥æ›´å®¹æ˜“æ˜ç™½
2. **èŠ‚çœå†…å­˜**ï¼šfirst/last æ–¹å¼èƒ½èŠ‚çœ new ä¸€ä¸ª headerEntry
   - å®ä¾‹åŒ– headerEntry æ˜¯ä¸ºäº†è®©åé¢çš„æ–¹æ³•æ›´åŠ ç»Ÿä¸€
   - å¦åˆ™ä¼šå¤šå¾ˆå¤š header çš„ç©ºæ ¡éªŒ
3. **æ“ä½œæ›´é«˜æ•ˆ**ï¼šåœ¨é“¾å¤´/å°¾è¿›è¡Œæ’å…¥/åˆ é™¤æ“ä½œï¼Œfirst/last æ–¹å¼æ›´åŠ å¿«æ·

**æ’å…¥/åˆ é™¤æ“ä½œåˆ†æ**ï¼š

æŒ‰ç…§ä½ç½®åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š**ä¸­é—´** å’Œ **ä¸¤å¤´**

- **åœ¨ä¸­é—´æ’å…¥/åˆ é™¤**ï¼šä¸¤è€…éƒ½ä¸€æ ·
  - å…ˆéå†æ‰¾åˆ° index
  - ç„¶åä¿®æ”¹é“¾è¡¨ index å¤„ä¸¤å¤´çš„æŒ‡é’ˆ
  
- **åœ¨ä¸¤å¤´**ï¼š
  - å¾ªç¯é“¾è¡¨ï¼šç”±äºé¦–å°¾ç›¸è¿ï¼Œè¿˜æ˜¯éœ€è¦å¤„ç†ä¸¤å¤´çš„æŒ‡é’ˆ
  - éå¾ªç¯é“¾è¡¨ï¼šåªéœ€è¦å¤„ç†ä¸€è¾¹ `first.previous` / `last.next`
  - ç†è®ºä¸Šéå¾ªç¯é“¾è¡¨æ›´é«˜æ•ˆ

> ğŸ’¡ æ°æ°åœ¨ä¸¤å¤´ï¼ˆé“¾å¤´/é“¾å°¾ï¼‰æ“ä½œæ˜¯æœ€æ™®éçš„ï¼Œæ‰€ä»¥å–æ¶ˆå¾ªç¯æ›´åˆç†ã€‚

---

### 3. ArrayList ä¸ LinkedList åŒºåˆ«

| ç‰¹æ€§ | ArrayList | LinkedList |
|------|-----------|------------|
| **çº¿ç¨‹å®‰å…¨** | ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ | ä¸ä¿è¯çº¿ç¨‹å®‰å…¨ |
| **åº•å±‚æ•°æ®ç»“æ„** | Object æ•°ç»„ | åŒå‘é“¾è¡¨ |
| **æ’å…¥/åˆ é™¤å—ä½ç½®å½±å“** | æ˜¯<br>æœ«å°¾æ·»åŠ ï¼šO(1)<br>æŒ‡å®šä½ç½®ï¼šO(n-i) | å¦<br>æœ«å°¾æ·»åŠ ï¼šO(1)<br>æŒ‡å®šä½ç½®ï¼šO(n) éœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½® |
| **å¿«é€Ÿéšæœºè®¿é—®** | æ”¯æŒï¼Œé€šè¿‡åºå·å¿«é€Ÿè·å–å…ƒç´  | ä¸æ”¯æŒ |
| **å†…å­˜ç©ºé—´å ç”¨** | list ç»“å°¾ä¼šé¢„ç•™ä¸€å®šçš„å®¹é‡ç©ºé—´ | æ¯ä¸ªå…ƒç´ éœ€è¦å­˜æ”¾ç›´æ¥åç»§ã€ç›´æ¥å‰é©±ä»¥åŠæ•°æ® |

**æ’å…¥å’Œåˆ é™¤æ—¶é—´å¤æ‚åº¦è¯¦è§£**ï¼š

**ArrayList**ï¼š
- `add(E e)`ï¼šé»˜è®¤åœ¨åˆ—è¡¨æœ«å°¾è¿½åŠ å…ƒç´ ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)
- `add(int index, E element)`ï¼šåœ¨æŒ‡å®šä½ç½® i æ’å…¥ï¼Œæ—¶é—´å¤æ‚åº¦ O(n-i)
  - å› ä¸ºç¬¬ i å’Œç¬¬ i ä¸ªå…ƒç´ ä¹‹åçš„ (n-i) ä¸ªå…ƒç´ éƒ½è¦æ‰§è¡Œå‘åä½/å‘å‰ç§»ä¸€ä½çš„æ“ä½œ

**LinkedList**ï¼š
- `add(E e)`ï¼šåœ¨é“¾è¡¨æœ«å°¾æ·»åŠ ï¼Œæ—¶é—´å¤æ‚åº¦ O(1)
- `add(int index, E element)`ï¼šåœ¨æŒ‡å®šä½ç½® i æ’å…¥ï¼Œæ—¶é—´å¤æ‚åº¦è¿‘ä¼¼ O(n)
  - å› ä¸ºéœ€è¦å…ˆç§»åŠ¨åˆ°æŒ‡å®šä½ç½®å†æ’å…¥

---

### 4. ArrayList å’Œ Vector çš„åŒºåˆ«

| ç‰¹æ€§ | ArrayList | Vector |
|------|-----------|--------|
| **å®ç°ç±»å‹** | List çš„ä¸»è¦å®ç°ç±» | List çš„å¤è€å®ç°ç±» |
| **åº•å±‚å®ç°** | Object[] å­˜å‚¨ | Object[] å­˜å‚¨ |
| **çº¿ç¨‹å®‰å…¨** | ä¸å®‰å…¨ | å®‰å…¨ |
| **é€‚ç”¨åœºæ™¯** | é€‚ç”¨äºé¢‘ç¹çš„æŸ¥æ‰¾å·¥ä½œ | éœ€è¦çº¿ç¨‹å®‰å…¨çš„åœºæ™¯ |

---

> ğŸ“š **å‚è€ƒèµ„æ–™**ï¼šæœ¬æ–‡å†…å®¹åŸºäºä¸ªäººå­¦ä¹ ç¬”è®°æ•´ç†
